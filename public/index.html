<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Stockholm Metro Art Map</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:'DM Sans',sans-serif;background:#0a0a0f;color:#e8e8e8;height:100vh;height:100dvh;display:flex;flex-direction:column;overflow:hidden}
header{background:linear-gradient(135deg,#0d1117,#161b22);border-bottom:1px solid rgba(255,255,255,.06);padding:12px 16px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;z-index:10}
h1{font-family:'Space Mono',monospace;font-size:16px;font-weight:700;background:linear-gradient(90deg,#60a5fa,#a78bfa);-webkit-background-clip:text;-webkit-text-fill-color:transparent;white-space:nowrap}
.legend{display:flex;gap:14px;flex-wrap:wrap;align-items:center}
.legend-item{display:flex;align-items:center;gap:6px;font-size:12px;color:#9ca3af}
.legend-dot,.legend-square{width:12px;height:12px;flex-shrink:0;border:2px solid rgba(255,255,255,.15)}
.legend-dot{border-radius:50%}.legend-square{border-radius:3px}
.legend-tri-wrap{width:12px;height:12px;flex-shrink:0;display:flex;align-items:center;justify-content:center}
.legend-tri{width:0;height:0;border-left:7px solid transparent;border-right:7px solid transparent;border-bottom:12px solid #9ca3af}
.dot-blue{background:#3b82f6;border-color:#60a5fa}.dot-orange{background:#f59e0b;border-color:#fbbf24}.square-green{background:#22c55e;border-color:#4ade80}
#map{flex:1;z-index:1}
.custom-popup .leaflet-popup-content-wrapper{background:#1e1e2e;color:#e8e8e8;border-radius:12px;border:1px solid rgba(255,255,255,.08);box-shadow:0 8px 32px rgba(0,0,0,.5);font-family:'DM Sans',sans-serif;padding:0;overflow:hidden}
.custom-popup .leaflet-popup-tip{background:#1e1e2e;border:1px solid rgba(255,255,255,.08)}
.custom-popup .leaflet-popup-content{margin:0;font-size:14px;line-height:1.5;width:260px!important}
.popup-img-wrap{width:100%;height:150px;background:#12121a;overflow:hidden;position:relative}
.popup-img-wrap img{width:100%;height:100%;object-fit:cover;display:block}
.popup-img-wrap .img-loading{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#4b5563;font-size:12px;font-family:'Space Mono',monospace}
.popup-body{padding:10px 12px}
.popup-name{font-family:'Space Mono',monospace;font-weight:700;font-size:14px;margin-bottom:6px}
.popup-tag{display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:500;text-transform:uppercase;letter-spacing:.5px}
.tag-both{background:rgba(255,255,255,.1);color:#e2e8f0}
.tag-article{background:rgba(255,255,255,.08);color:#d1d5db}
.tag-list{background:rgba(255,255,255,.08);color:#d1d5db}
.popup-line{margin-top:5px;font-size:12px;color:#9ca3af}
.popup-search{display:inline-block;margin-top:8px;padding:5px 10px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);border-radius:6px;color:#93c5fd;text-decoration:none;font-size:11px;font-family:'Space Mono',monospace;transition:background .15s}
.popup-search:hover{background:rgba(255,255,255,.12)}
.sidebar{position:absolute;top:70px;right:10px;z-index:1000;background:rgba(22,27,34,.92);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:14px;width:220px;max-height:calc(100dvh - 90px);overflow-y:auto;font-size:13px}
.sidebar h3{font-family:'Space Mono',monospace;font-size:10px;text-transform:uppercase;letter-spacing:1px;color:#6b7280;margin-bottom:8px}
.sidebar ul{list-style:none;padding:0}
.sidebar li{padding:5px 7px;border-radius:6px;cursor:pointer;display:flex;align-items:center;gap:7px;transition:background .15s;font-size:12px}
.sidebar li:hover{background:rgba(255,255,255,.05)}
.sidebar .s-dot,.sidebar .s-square{width:9px;height:9px;flex-shrink:0}
.sidebar .s-dot{border-radius:50%}.sidebar .s-square{border-radius:2px}
.sidebar .s-tri{width:0;height:0;border-left:5px solid transparent;border-right:5px solid transparent;border-bottom:9px solid #9ca3af;flex-shrink:0}
.s-blue{background:#3b82f6}.s-orange{background:#f59e0b}.s-green{background:#22c55e}.s-red{background:#ef4444}.s-multi{background:linear-gradient(135deg,#3b82f6,#ef4444,#22c55e)}
.mobile-toggle{display:none;position:absolute;bottom:16px;left:50%;transform:translateX(-50%);z-index:1000;background:rgba(22,27,34,.95);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.1);border-radius:24px;padding:10px 20px;color:#e8e8e8;font-family:'Space Mono',monospace;font-size:12px;cursor:pointer;box-shadow:0 4px 20px rgba(0,0,0,.4)}
.mobile-sheet{display:none;position:absolute;bottom:0;left:0;right:0;z-index:1001;background:rgba(22,27,34,.97);backdrop-filter:blur(16px);border-top:1px solid rgba(255,255,255,.08);border-radius:16px 16px 0 0;padding:12px 16px 24px;max-height:50dvh;overflow-y:auto;transform:translateY(100%);transition:transform .3s ease}
.mobile-sheet.open{transform:translateY(0)}
.mobile-sheet .drag-handle{width:36px;height:4px;background:rgba(255,255,255,.2);border-radius:2px;margin:0 auto 12px}
.mobile-sheet ul{list-style:none;padding:0}
.mobile-sheet li{padding:8px 10px;border-radius:8px;cursor:pointer;display:flex;align-items:center;gap:8px;font-size:14px}
.mobile-sheet li:active{background:rgba(255,255,255,.08)}
.mobile-sheet .s-dot,.mobile-sheet .s-square{width:10px;height:10px;flex-shrink:0}
.mobile-sheet .s-dot{border-radius:50%}.mobile-sheet .s-square{border-radius:2px}
.mobile-sheet .s-tri{width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-bottom:10px solid #9ca3af;flex-shrink:0}
@media(max-width:700px){
  header{padding:10px 12px;gap:6px}
  h1{font-size:13px}
  .legend{gap:10px}
  .legend-item{font-size:10px;gap:4px}
  .legend-dot,.legend-square{width:10px;height:10px}
  .sidebar{display:none}
  .mobile-toggle{display:block}
  .mobile-sheet{display:block}
  .custom-popup .leaflet-popup-content{width:240px!important}
  .popup-img-wrap{height:130px}
}
</style>
</head>
<body>

<header>
  <h1>üöá Stockholm Metro Art</h1>
  <div class="legend">
    <div class="legend-item"><div class="legend-dot" style="background:#9ca3af;border-color:#d1d5db"></div>Pr≈Ønik</div>
    <div class="legend-item"><div class="legend-tri-wrap"><div class="legend-tri"></div></div>ƒål√°nek</div>
    <div class="legend-item"><div class="legend-square" style="background:#9ca3af;border-color:#d1d5db"></div>Seznam</div>
    <span style="color:#4b5563;font-size:11px;margin-left:4px">‚îÇ</span>
    <div class="legend-item"><span style="width:10px;height:10px;border-radius:50%;background:#3b82f6;display:inline-block"></span>Blue</div>
    <div class="legend-item"><span style="width:10px;height:10px;border-radius:50%;background:#ef4444;display:inline-block"></span>Red</div>
    <div class="legend-item"><span style="width:10px;height:10px;border-radius:50%;background:#22c55e;display:inline-block"></span>Green</div>
  </div>
</header>

<div id="map"></div>

<div class="sidebar" id="sidebar">
  <h3>Stanice</h3>
  <ul id="station-list"></ul>
</div>

<div class="mobile-toggle" onclick="toggleSheet()">‚ñ≤ Seznam stanic</div>
<div class="mobile-sheet" id="mobileSheet">
  <div class="drag-handle"></div>
  <ul id="mobile-list"></ul>
</div>

<script>
var stations = [
  {n:"T-Centralen",a:59.331,o:18.0596,t:"both",l:"Blue / Red / Green",w:"T-Centralen_metro_station"},
  {n:"Stadion",a:59.3428,o:18.0825,t:"both",l:"Red Line",w:"Stadion_metro_station"},
  {n:"Solna Centrum",a:59.36,o:18.0003,t:"both",l:"Blue Line",w:"Solna_centrum_metro_station"},
  {n:"Tekniska H√∂gskolan",a:59.3458,o:18.0716,t:"both",l:"Red Line",w:"Tekniska_h%C3%B6gskolan_metro_station"},
  {n:"Tensta",a:59.3942,o:17.9035,t:"both",l:"Blue Line",w:"Tensta_metro_station"},
  {n:"Kungstr√§dg√•rden",a:59.3308,o:18.0714,t:"both",l:"Blue Line",w:"Kungstr%C3%A4dg%C3%A5rden_metro_station"},
  {n:"M√∂rby Centrum",a:59.3982,o:18.0364,t:"both",l:"Red Line",w:"M%C3%B6rby_centrum_metro_station"},
  {n:"Odenplan",a:59.3428,o:18.049,t:"both",l:"Green / Citybanan",w:"Odenplan_metro_station"},
  {n:"R√•dhuset",a:59.3305,o:18.0474,t:"article",l:"Blue Line",w:"R%C3%A5dhuset_metro_station"},
  {n:"Akalla",a:59.4143,o:17.913,t:"article",l:"Blue Line",w:"Akalla_metro_station"},
  {n:"Universitetet",a:59.3652,o:18.0555,t:"article",l:"Red Line",w:"Universitetet_metro_station"},
  {n:"Bagarmossen",a:59.2768,o:18.131,t:"list",l:"Green Line",w:"Bagarmossen_metro_station"},
  {n:"Hallonbergen",a:59.3742,o:17.982,t:"list",l:"Blue Line",w:"Hallonbergen_metro_station"},
  {n:"H√∂torget",a:59.3353,o:18.0636,t:"list",l:"Green Line",w:"H%C3%B6torget_metro_station"},
  {n:"√ñstermalmstorg",a:59.3346,o:18.0755,t:"list",l:"Red Line",w:"%C3%96stermalmstorg_metro_station"},
  {n:"Solna Strand",a:59.359,o:17.9745,t:"list",l:"Blue Line",w:"Solna_strand_metro_station"},
  {n:"Thorildsplan",a:59.3322,o:18.0235,t:"list",l:"Green Line",w:"Thorildsplan_metro_station"}
];

var metroLines = [
  {c:"#3b82f6",p:[[59.3308,18.0714],[59.331,18.0596],[59.3305,18.0474],[59.332,18.032],[59.3385,18.013],[59.35,17.99],[59.359,17.9745],[59.365,17.978],[59.3742,17.982],[59.381,17.975],[59.36,18.0003]]},
  {c:"#3b82f6",p:[[59.3742,17.982],[59.383,17.95],[59.39,17.925],[59.4143,17.913]]},
  {c:"#3b82f6",p:[[59.365,17.978],[59.375,17.94],[59.3942,17.9035]]},
  {c:"#ef4444",p:[[59.285,18],[59.295,18.023],[59.302,18.034],[59.308,18.05],[59.313,18.063],[59.318,18.072],[59.323,18.068],[59.331,18.0596],[59.3346,18.0755],[59.3428,18.0825],[59.3458,18.0716],[59.3652,18.0555],[59.38,18.045],[59.392,18.04],[59.3982,18.0364]]},
  {c:"#22c55e",p:[[59.333,17.995],[59.33,18.01],[59.3322,18.0235],[59.339,18.038],[59.3428,18.049],[59.34,18.056],[59.3353,18.0636],[59.331,18.0596],[59.323,18.068],[59.318,18.072],[59.313,18.075],[59.308,18.078],[59.298,18.085],[59.292,18.095],[59.287,18.105],[59.281,18.118],[59.2768,18.131]]}
];

var map = L.map('map', {zoomControl: false}).setView([59.345, 18.02], 12);
L.control.zoom({position: 'topleft'}).addTo(map);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
  attribution: '¬© OSM ¬© CARTO', subdomains: 'abcd', maxZoom: 19
}).addTo(map);

metroLines.forEach(function(l) {
  L.polyline(l.p, {color: l.c, weight: 3, opacity: 0.4, dashArray: '8 6', lineCap: 'round'}).addTo(map);
});

var allMarkers = {};

function lineColor(line) {
  if (/Blue/.test(line) && /Red/.test(line) && /Green/.test(line)) return null; // multi
  if (/Blue/.test(line)) return {bg:'#3b82f6',border:'#93c5fd',shadow:'59,130,246'};
  if (/Red/.test(line)) return {bg:'#ef4444',border:'#f87171',shadow:'239,68,68'};
  if (/Green/.test(line)) return {bg:'#22c55e',border:'#86efac',shadow:'34,197,94'};
  return {bg:'#a78bfa',border:'#c4b5fd',shadow:'167,139,250'};
}

function createIcon(t, line) {
  var lc = lineColor(line);
  var isMulti = !lc;
  if (t === 'both') {
    // Circle
    var bg = isMulti ? 'background:conic-gradient(#3b82f6 0deg 120deg,#ef4444 120deg 240deg,#22c55e 240deg 360deg)' : 'background:'+lc.bg;
    var border = isMulti ? 'border:3px solid #e2e8f0' : 'border:3px solid '+lc.border;
    var shadow = isMulti ? 'box-shadow:0 0 12px rgba(167,139,250,.5)' : 'box-shadow:0 0 12px rgba('+lc.shadow+',.5)';
    var style = 'width:18px;height:18px;border-radius:50%;'+bg+';'+border+';'+shadow;
    return L.divIcon({className:'', html:'<div style="'+style+'"></div>', iconSize:[18,18], iconAnchor:[9,9], popupAnchor:[0,-12]});
  } else if (t === 'article') {
    // Triangle (CSS triangle via border)
    var color = isMulti ? '#a78bfa' : lc.bg;
    var glow = isMulti ? '167,139,250' : lc.shadow;
    var html = '<div style="width:0;height:0;border-left:10px solid transparent;border-right:10px solid transparent;border-bottom:18px solid '+color+';filter:drop-shadow(0 0 6px rgba('+glow+',.6))"></div>';
    return L.divIcon({className:'', html:html, iconSize:[20,18], iconAnchor:[10,18], popupAnchor:[0,-20]});
  } else {
    // Square
    var bg2 = isMulti ? 'background:conic-gradient(#3b82f6,#ef4444,#22c55e)' : 'background:'+lc.bg;
    var border2 = isMulti ? 'border:3px solid #e2e8f0' : 'border:3px solid '+lc.border;
    var shadow2 = isMulti ? 'box-shadow:0 0 12px rgba(167,139,250,.5)' : 'box-shadow:0 0 12px rgba('+lc.shadow+',.5)';
    var style2 = 'width:16px;height:16px;border-radius:3px;'+bg2+';'+border2+';'+shadow2;
    return L.divIcon({className:'', html:'<div style="'+style2+'"></div>', iconSize:[16,16], iconAnchor:[8,8], popupAnchor:[0,-12]});
  }
}

function tagHtml(t) {
  return {
    both: '<span class="popup-tag tag-both">Pr≈Ønik</span>',
    article: '<span class="popup-tag tag-article">Pouze ƒçl√°nek</span>',
    list: '<span class="popup-tag tag-list">Pouze seznam</span>'
  }[t];
}

function googleImg(name) {
  return 'https://www.google.com/search?tbm=isch&q=' + encodeURIComponent(name + ' metro station Stockholm art');
}

// Convert remote image URL to blob URL to bypass hotlink restrictions
async function toBlobUrl(url) {
  try {
    var r = await fetch(url, {referrerPolicy:'no-referrer'});
    if (!r.ok) return null;
    var blob = await r.blob();
    return URL.createObjectURL(blob);
  } catch(e) { return null; }
}

function popupHtml(s, imgUrl) {
  var img = imgUrl
    ? '<div class="popup-img-wrap"><img src="'+imgUrl+'" alt="'+s.n+'" onerror="this.parentElement.style.display=\'none\'" /></div>'
    : '';
  return img + '<div class="popup-body"><div class="popup-name">'+s.n+'</div>'+tagHtml(s.t)+'<div class="popup-line">üìç '+s.l+'</div><a class="popup-search" href="'+googleImg(s.n)+'" target="_blank" rel="noopener">üîç V√≠ce fotek</a></div>';
}

function loadingPopup(s) {
  return '<div class="popup-img-wrap"><div class="img-loading">üì∑ Naƒç√≠t√°m‚Ä¶</div></div><div class="popup-body"><div class="popup-name">'+s.n+'</div>'+tagHtml(s.t)+'<div class="popup-line">üìç '+s.l+'</div><a class="popup-search" href="'+googleImg(s.n)+'" target="_blank" rel="noopener">üîç V√≠ce fotek</a></div>';
}

// Use MediaWiki Action API with origin=* for CORS
async function fetchWikiThumb(wiki) {
  var title = decodeURIComponent(wiki).replace(/_/g, ' ');
  var methods = [
    // Method 1: Action API with pageimages
    async function() {
      var u = 'https://en.wikipedia.org/w/api.php?action=query&titles=' + encodeURIComponent(title) + '&prop=pageimages&pithumbsize=640&format=json&origin=*';
      var r = await fetch(u);
      var d = await r.json();
      var pg = Object.values(d.query.pages)[0];
      return (pg && pg.thumbnail) ? pg.thumbnail.source : null;
    },
    // Method 2: REST API
    async function() {
      var r = await fetch('https://en.wikipedia.org/api/rest_v1/page/summary/' + wiki);
      var d = await r.json();
      return (d.thumbnail && d.thumbnail.source) ? d.thumbnail.source : null;
    },
    // Method 3: Action API with images prop
    async function() {
      var u = 'https://en.wikipedia.org/w/api.php?action=query&titles=' + encodeURIComponent(title) + '&prop=images&format=json&origin=*';
      var r = await fetch(u);
      var d = await r.json();
      var pg = Object.values(d.query.pages)[0];
      if (pg && pg.images && pg.images.length > 0) {
        // Find first jpg/png image
        var img = pg.images.find(function(i) { return /\.(jpg|jpeg|png)$/i.test(i.title); });
        if (img) {
          var fname = img.title.replace('File:', '');
          var u2 = 'https://en.wikipedia.org/w/api.php?action=query&titles=File:' + encodeURIComponent(fname) + '&prop=imageinfo&iiprop=url&iiurlwidth=640&format=json&origin=*';
          var r2 = await fetch(u2);
          var d2 = await r2.json();
          var pg2 = Object.values(d2.query.pages)[0];
          return (pg2 && pg2.imageinfo && pg2.imageinfo[0]) ? pg2.imageinfo[0].thumburl : null;
        }
      }
      return null;
    }
  ];
  for (var i = 0; i < methods.length; i++) {
    try {
      var url = await methods[i]();
      if (url) return url;
    } catch(e) { console.log('Method ' + (i+1) + ' failed for ' + title, e); }
  }
  return null;
}

var imageCache = {};
var listEl = document.getElementById('station-list');
var mobileListEl = document.getElementById('mobile-list');

var sorted = [...stations].sort(function(a, b) {
  var order = {both:0, article:1, list:2};
  return order[a.t] - order[b.t] || a.n.localeCompare(b.n);
});

sorted.forEach(function(s) {
  var icon = createIcon(s.t, s.l);
  var marker = L.marker([s.a, s.o], {icon: icon})
    .addTo(map)
    .bindPopup(loadingPopup(s), {className:'custom-popup', maxWidth:280, minWidth:240});

  marker.on('popupopen', async function() {
    if (imageCache[s.w] !== undefined) {
      marker.setPopupContent(popupHtml(s, imageCache[s.w]));
      marker.getPopup().update();
      return;
    }
    console.log('Fetching image for: ' + s.n + ' (' + s.w + ')');
    var imgUrl = await fetchWikiThumb(s.w);
    console.log('Wiki image URL for ' + s.n + ':', imgUrl);
    if (imgUrl) {
      var blobUrl = await toBlobUrl(imgUrl);
      console.log('Blob result for ' + s.n + ':', blobUrl ? 'OK' : 'FAILED - trying direct');
      imageCache[s.w] = blobUrl || imgUrl;
    } else {
      imageCache[s.w] = '';
    }
    marker.setPopupContent(popupHtml(s, imageCache[s.w]));
    marker.getPopup().update();
  });

  allMarkers[s.n] = marker;

  [listEl, mobileListEl].forEach(function(el) {
    var li = document.createElement('li');
    // Color based on line
    var lc = lineColor(s.l);
    var colorClass = !lc ? 's-multi' : /Blue/.test(s.l) ? 's-blue' : /Red/.test(s.l) ? 's-red' : 's-green';
    // Shape based on type
    if (s.t === 'both') {
      li.innerHTML = '<div class="s-dot '+colorClass+'"></div>' + s.n;
    } else if (s.t === 'article') {
      var triColor = !lc ? '#a78bfa' : lc.bg;
      li.innerHTML = '<div class="s-tri" style="border-bottom-color:'+triColor+'"></div>' + s.n;
    } else {
      li.innerHTML = '<div class="s-square '+colorClass+'"></div>' + s.n;
    }
    li.addEventListener('click', function() {
      map.setView([s.a, s.o], 15, {animate: true});
      marker.openPopup();
      closeSheet();
    });
    el.appendChild(li);
  });
});

var group = L.featureGroup(Object.values(allMarkers));
map.fitBounds(group.getBounds().pad(0.1));

function toggleSheet() {
  document.getElementById('mobileSheet').classList.toggle('open');
}
function closeSheet() {
  document.getElementById('mobileSheet').classList.remove('open');
}
map.on('click', closeSheet);
</script>
</body>
</html>
